# 宝塔面板部署指南

本文档详细介绍如何使用宝塔面板（BT Panel）部署 A 股股票监测系统。

## 目录

- [环境准备](#环境准备)
- [安装必要软件](#安装必要软件)
- [数据库配置](#数据库配置)
- [后端部署](#后端部署)
- [前端部署](#前端部署)
- [Nginx 反向代理配置](#nginx-反向代理配置)
- [SSL 证书配置](#ssl-证书配置)
- [常见问题](#常见问题)

---

## 环境准备

### 服务器要求

| 配置项 | 最低要求 | 推荐配置 |
|-------|---------|---------|
| CPU | 1 核 | 2 核+ |
| 内存 | 2GB | 4GB+ |
| 硬盘 | 20GB | 50GB+ |
| 系统 | CentOS 7+ / Ubuntu 18+ | CentOS 7.9 / Ubuntu 20.04 |

### 安装宝塔面板

```bash
# CentOS
yum install -y wget && wget -O install.sh https://download.bt.cn/install/install_6.0.sh && sh install.sh ed8484bec

# Ubuntu/Debian
wget -O install.sh https://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh ed8484bec
```

安装完成后，记录面板地址、用户名和密码。

---

## 安装必要软件

登录宝塔面板后，在「软件商店」中安装以下软件：

### 必装软件

| 软件 | 版本要求 | 说明 |
|-----|---------|------|
| Nginx | 1.20+ | Web 服务器 |
| MySQL | 8.0+ | 数据库 |
| Supervisor 管理器 | 最新版 | 进程守护管理 |
| PM2 管理器 | 最新版 | Node.js 进程管理 |

### 安装步骤

1. 进入「软件商店」→「运行环境」
2. 安装 Nginx（推荐 1.22）
3. 安装 MySQL 8.0
4. 安装「Supervisor 管理器」（用于管理 Python 后端进程）
5. 安装「PM2 管理器」（用于管理 Node.js 进程）

> ⚠️ **注意**：不推荐使用「Python 项目管理器」，该插件在某些系统上存在 pip 兼容性问题。推荐使用 Supervisor 方式部署后端服务。

---

## 数据库配置

### 1. 创建数据库

1. 进入「数据库」→「添加数据库」
2. 填写信息：
   - 数据库名：`stock_monitor`
   - 用户名：`stock_monitor`
   - 密码：自动生成或自定义（记住此密码）
   - 访问权限：本地服务器

### 2. 导入数据库

1. 点击数据库右侧的「导入」按钮
2. 上传 `init_mysql.sql` 文件
3. 点击「导入」执行

或者使用命令行：

```bash
mysql -u stock_monitor -p stock_monitor < /www/wwwroot/stock-monitor/init_mysql.sql
```

---

## 后端部署

### 1. 上传代码

1. 进入「文件」→ `/www/wwwroot/`
2. 使用 Git 克隆项目：

```bash
cd /www/wwwroot/
git clone https://github.com/spellyaohui/A-share-stock-monitoring-system-mobile-application.git stock-monitor
```

### 2. 创建 Python 虚拟环境

SSH 登录服务器，手动创建虚拟环境并安装依赖：

```bash
cd /www/wwwroot/stock-monitor/stock-monitor-backend

# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 确保安装 gunicorn 和 uvicorn
pip install gunicorn uvicorn
```

### 3. 配置环境变量

1. 复制环境变量模板：

```bash
cd /www/wwwroot/stock-monitor/stock-monitor-backend
cp .env.example .env
```

2. 编辑 `.env` 文件：

```bash
# 应用配置
APP_NAME=Stock Monitor System
APP_VERSION=1.0.0
DEBUG=False

# 服务器配置
HOST=0.0.0.0
PORT=8000

# 数据库配置（使用宝塔创建的数据库信息）
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=stock_monitor
MYSQL_PASSWORD=你的数据库密码
MYSQL_DB=stock_monitor

# JWT 配置（生成随机密钥）
SECRET_KEY=生成一个32位以上的随机字符串
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=10080

# CORS 配置
CORS_ORIGINS=https://your-domain.com,https://m.your-domain.com
```

生成随机密钥：

```bash
python3 -c "import secrets; print(secrets.token_urlsafe(32))"
```

### 4. 使用 Supervisor 管理后端服务

由于宝塔的「Python 项目管理器」在某些系统上存在兼容性问题，推荐使用 Supervisor 来管理后端进程。

#### 4.1 打开 Supervisor 管理器

1. 进入「软件商店」→ 找到「Supervisor 管理器」→ 点击「设置」
2. 点击「添加守护进程」

#### 4.2 配置守护进程

填写以下信息：

| 配置项 | 值 |
|-------|-----|
| 名称 | `stock-monitor` |
| 启动命令 | `/www/wwwroot/stock-monitor/stock-monitor-backend/venv/bin/gunicorn -w 4 -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8000 app.main:app` |
| 运行目录 | `/www/wwwroot/stock-monitor/stock-monitor-backend` |
| 启动用户 | `root` |

或者直接编辑配置文件，添加以下内容：

```ini
[program:stock-monitor]
command=/www/wwwroot/stock-monitor/stock-monitor-backend/venv/bin/gunicorn -w 4 -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8000 app.main:app
directory=/www/wwwroot/stock-monitor/stock-monitor-backend
autorestart=true
startsecs=3
startretries=3
stdout_logfile=/www/server/panel/plugin/supervisor/log/stock-monitor.out.log
stderr_logfile=/www/server/panel/plugin/supervisor/log/stock-monitor.err.log
stdout_logfile_maxbytes=2MB
stderr_logfile_maxbytes=2MB
user=root
priority=999
numprocs=1
process_name=%(program_name)s_%(process_num)02d
```

#### 4.3 启动参数说明

| 参数 | 说明 |
|-----|------|
| `-w 4` | 4 个工作进程（可根据 CPU 核心数调整） |
| `-k uvicorn.workers.UvicornWorker` | 使用 Uvicorn 异步工作类 |
| `-b 0.0.0.0:8000` | 绑定地址和端口 |

#### 4.4 启动服务

1. 保存配置后，点击「启动」按钮
2. 确认状态显示为「运行中」

#### 4.5 验证服务

```bash
# 检查进程是否运行
ps aux | grep gunicorn

# 测试 API 是否正常
curl http://127.0.0.1:8000/api/health

# 查看日志
tail -f /www/server/panel/plugin/supervisor/log/stock-monitor.out.log
```

---

## 前端部署

### 1. 安装 Node.js

在 PM2 管理器中：

1. 点击「Node 版本」
2. 安装 Node.js 18.x 或 20.x

### 2. 构建 PC 端

```bash
cd /www/wwwroot/stock-monitor/stock-monitor-pc

# 安装依赖
npm install

# 修改 API 地址（如果需要）
# 编辑 src/utils/request.ts，修改 baseURL

# 构建
npm run build
```

### 3. 构建移动端 H5

```bash
cd /www/wwwroot/stock-monitor/stock-monitor-mobile

# 安装依赖
npm install

# 修改 API 地址（如果需要）
# 编辑 utils/request.ts，修改 BASE_URL

# 构建
npm run build:h5
```

### 4. 部署静态文件

构建完成后，静态文件位置：
- PC 端：`stock-monitor-pc/dist/`
- 移动端：`stock-monitor-mobile/dist/build/h5/`

---

## Nginx 反向代理配置

### 1. 创建网站

1. 进入「网站」→「添加站点」
2. 填写域名（如 `stock.your-domain.com`）
3. 选择「纯静态」
4. 创建完成

### 2. 配置 Nginx

点击网站右侧「设置」→「配置文件」，替换为以下配置：

```nginx
server {
    listen 80;
    listen 443 ssl http2;
    server_name stock.your-domain.com;
    
    # SSL 配置（宝塔会自动添加）
    # ssl_certificate    /www/server/panel/vhost/cert/stock.your-domain.com/fullchain.pem;
    # ssl_certificate_key    /www/server/panel/vhost/cert/stock.your-domain.com/privkey.pem;
    
    # 日志
    access_log /www/wwwlogs/stock-monitor.log;
    error_log /www/wwwlogs/stock-monitor.error.log;

    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1k;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml
               application/rss+xml font/truetype font/opentype
               application/vnd.ms-fontobject image/svg+xml;

    # PC 端（默认）
    location / {
        root /www/wwwroot/stock-monitor/stock-monitor-pc/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
        
        # 缓存静态资源
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
    }

    # 移动端 H5
    location /m/ {
        alias /www/wwwroot/stock-monitor/stock-monitor-mobile/dist/build/h5/;
        index index.html;
        try_files $uri $uri/ /m/index.html;
        
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
    }

    # API 代理
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # WebSocket 代理
    location /ws/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # WebSocket 长连接
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
    }

    # 禁止访问敏感文件
    location ~ /\.(git|env) {
        deny all;
    }
}
```

### 3. 重载 Nginx

点击「服务」→「重载配置」

---

## SSL 证书配置

### 方式一：宝塔免费证书

1. 进入网站「设置」→「SSL」
2. 选择「Let's Encrypt」
3. 勾选域名，点击「申请」
4. 开启「强制 HTTPS」

### 方式二：自有证书

1. 进入网站「设置」→「SSL」
2. 选择「其他证书」
3. 粘贴证书内容和私钥
4. 保存并开启「强制 HTTPS」

---

## 开机自启配置

### 后端服务

Supervisor 管理器默认支持开机自启，确保守护进程状态为「运行中」即可。

### 检查服务状态

```bash
# 查看 Supervisor 管理的进程
supervisorctl status

# 查看后端进程
ps aux | grep gunicorn

# 查看端口占用
netstat -tlnp | grep 8000
```

### Supervisor 常用命令

```bash
# 启动服务
supervisorctl start stock-monitor:*

# 停止服务
supervisorctl stop stock-monitor:*

# 重启服务
supervisorctl restart stock-monitor:*

# 查看状态
supervisorctl status stock-monitor:*

# 重新加载配置
supervisorctl reread
supervisorctl update
```

---

## 常见问题

### 1. 后端启动失败

**查看 Supervisor 日志**：

```bash
# 查看输出日志
tail -100 /www/server/panel/plugin/supervisor/log/stock-monitor.out.log

# 查看错误日志
tail -100 /www/server/panel/plugin/supervisor/log/stock-monitor.err.log
```

**常见原因**：
- 依赖未安装完整：重新执行 `pip install -r requirements.txt`
- 环境变量配置错误：检查 `.env` 文件
- 端口被占用：更换端口或停止占用进程
- 虚拟环境路径错误：确认 `venv` 目录存在

**手动测试启动**：

```bash
cd /www/wwwroot/stock-monitor/stock-monitor-backend
source venv/bin/activate
gunicorn -w 1 -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8000 app.main:app
```

### 2. 数据库连接失败

**检查**：
- 数据库用户名密码是否正确
- 数据库是否已创建
- MySQL 服务是否运行

```bash
# 测试数据库连接
mysql -u stock_monitor -p -e "SELECT 1"
```

### 3. 前端页面空白

**检查**：
- Nginx 配置是否正确
- 静态文件路径是否存在
- 浏览器控制台是否有错误

```bash
# 检查文件是否存在
ls -la /www/wwwroot/stock-monitor/stock-monitor-pc/dist/
```

### 4. API 请求 404

**检查**：
- Nginx 反向代理配置
- 后端服务是否运行
- API 路径是否正确

```bash
# 测试后端服务
curl http://127.0.0.1:8000/api/health
```

### 5. WebSocket 连接失败

**检查**：
- Nginx WebSocket 配置
- 防火墙是否放行
- 后端 WebSocket 服务是否正常

### 6. 股票数据获取失败

**检查**：
- 服务器网络是否正常
- AkShare 是否安装正确

```bash
# 测试 AkShare
python3 -c "import akshare as ak; print(ak.__version__)"
```

---

## 防火墙配置

在宝塔「安全」中放行以下端口：

| 端口 | 说明 |
|-----|------|
| 80 | HTTP |
| 443 | HTTPS |
| 8000 | 后端 API（可选，如果需要直接访问） |

---

## 性能优化建议

### 1. 开启 OPcache（PHP 项目不需要）

### 2. 配置 MySQL 缓存

在 MySQL 配置中增加：

```ini
[mysqld]
innodb_buffer_pool_size = 512M
query_cache_size = 64M
```

### 3. 配置 Nginx 缓存

已在上述配置中包含静态资源缓存。

### 4. 使用 CDN

将静态资源托管到 CDN 可以加速访问。

---

## 备份策略

### 数据库备份

1. 进入「计划任务」
2. 添加任务：备份数据库
3. 选择 `stock_monitor` 数据库
4. 设置执行周期（建议每天凌晨 2 点）

### 文件备份

1. 进入「计划任务」
2. 添加任务：备份目录
3. 选择 `/www/wwwroot/stock-monitor/`
4. 设置执行周期

---

## 更新部署

```bash
cd /www/wwwroot/stock-monitor

# 拉取最新代码
git pull

# 更新后端依赖
cd stock-monitor-backend
source venv/bin/activate
pip install -r requirements.txt

# 重启后端服务
supervisorctl restart stock-monitor:*

# 重新构建前端
cd ../stock-monitor-pc
npm install
npm run build

cd ../stock-monitor-mobile
npm install
npm run build:h5
```

---

**文档版本**：1.1  
**最后更新**：2025年12月
